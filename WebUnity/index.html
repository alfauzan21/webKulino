<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Kulino Game - Loading...</title>
    <link rel="shortcut icon" href="TemplateData/favicon.ico" />
    <link rel="stylesheet" href="TemplateData/style.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
    
    <!-- Solana & SPL Token Libraries -->
    <script src="https://unpkg.com/@solana/web3.js@latest/lib/index.iife.min.js"></script>
    <script src="https://unpkg.com/@solana/spl-token@latest/lib/index.iife.min.js"></script>
    <script src="https://unpkg.com/bs58@4.0.1/dist/index.min.js"></script>
    
    <style>
      html,body { height:100%; margin:0; background:#222; color:#fff; font-family: Arial, sans-serif; }
      #unity-container.unity-desktop { width:100%; height:100%; display:flex; align-items:center; justify-content:center; }
      #unity-loading-bar { position:absolute; top:50%; left:50%; transform:translate(-50%, -50%); text-align: center; }
      .game-info { position: absolute; top: 10px; left: 10px; background: rgba(0,0,0,0.7); padding: 10px; border-radius: 8px; font-size: 12px; }
      .game-info strong { color: #4ade80; }
    </style>
  </head>
  
  <body>
    <!-- Game Info Display -->
    <div class="game-info">
      <div>üéÆ Game: <strong id="gameIdDisplay">Loading...</strong></div>
      <div>üëõ Wallet: <strong id="walletDisplay">Not Connected</strong></div>
    </div>

    <div id="unity-container" class="unity-desktop">
      <canvas id="unity-canvas" width="1280" height="720" tabindex="-1"></canvas>
      <div id="unity-loading-bar" style="display:block">
        <div id="unity-logo"></div>
        <div id="unity-progress-bar-empty">
          <div id="unity-progress-bar-full"></div>
        </div>
        <div style="margin-top: 10px;">Loading Game...</div>
      </div>
      <div id="unity-warning"></div>
    </div>

    <!-- Kulino Bridge Script -->
    <script src="bridge.js"></script>

    <!-- Parse URL Parameters & Initialize -->
    <script>
      console.log('üöÄ WebUnity Page Loading...');
      
      // Parse URL parameters
      const urlParams = new URLSearchParams(window.location.search);
      const walletAddress = urlParams.get('wallet');
      const gameId = urlParams.get('game');

      console.log('üìã URL Parameters:');
      console.log('  - Wallet:', walletAddress);
      console.log('  - Game ID:', gameId);

      // Update display
      if (gameId) {
        document.getElementById('gameIdDisplay').textContent = gameId;
        document.title = `Kulino Game - ${gameId}`;
      }
      if (walletAddress) {
        const shortAddr = walletAddress.slice(0, 6) + '...' + walletAddress.slice(-4);
        document.getElementById('walletDisplay').textContent = shortAddr;
      }

      // Store in localStorage for Unity to access
      if (walletAddress) {
        localStorage.setItem('kulino_wallet_address', walletAddress);
        console.log('‚úÖ Wallet saved to localStorage');
      }
      if (gameId) {
        localStorage.setItem('kulino_current_game', gameId);
        console.log('‚úÖ Game ID saved to localStorage');
      }

      // Banner helper function
      function unityShowBanner(msg, type) {
        try {
          var warningBanner = document.querySelector("#unity-warning");
          function updateBannerVisibility() {
            warningBanner.style.display = warningBanner.children.length ? "block" : "none";
          }
          var div = document.createElement("div");
          div.textContent = msg;
          div.style.padding = "8px";
          div.style.margin = "6px";
          div.style.background = type === "error" ? "rgba(200,0,0,0.9)" : 
                                 type === "warning" ? "rgba(200,160,0,0.9)" : 
                                 "rgba(0,0,0,0.6)";
          warningBanner.appendChild(div);
          if (type !== "error") {
            setTimeout(function() { 
              warningBanner.removeChild(div); 
              updateBannerVisibility(); 
            }, 5000);
          }
          updateBannerVisibility();
        } catch(e) { 
          console.warn('unityShowBanner error', e); 
        }
      }

      // Unity Loader
      var canvas = document.querySelector("#unity-canvas");
      var buildUrl = "Build";
      var loaderUrl = buildUrl + "/WebUnity.loader.js";
      
      var config = {
        dataUrl: buildUrl + "/WebUnity.data",
        frameworkUrl: buildUrl + "/WebUnity.framework.js",
        codeUrl: buildUrl + "/WebUnity.wasm",
        streamingAssetsUrl: "StreamingAssets",
        companyName: "Kulino",
        productName: gameId || "Kulino Game",
        productVersion: "1.0",
        showBanner: unityShowBanner,
        matchWebGLToCanvasSize: false,
        devicePixelRatio: 1
      };

      document.querySelector("#unity-loading-bar").style.display = "block";

      var script = document.createElement("script");
      script.src = loaderUrl;
      
      script.onload = () => {
        console.log('üì¶ Unity Loader loaded, creating instance...');
        
        createUnityInstance(canvas, config, (progress) => {
          var progressBar = document.querySelector("#unity-progress-bar-full");
          if (progressBar) {
            progressBar.style.width = 100 * progress + "%";
          }
          console.log('‚è≥ Loading progress:', Math.round(progress * 100) + '%');
        }).then((unityInstance) => {
          console.log('‚úÖ Unity Instance Created!');
          
          document.querySelector("#unity-loading-bar").style.display = "none";
          window.unityInstance = unityInstance;
          
          // Send data to Unity
          console.log('üì§ Sending data to Unity...');
          
          if (walletAddress) {
            try {
              unityInstance.SendMessage('GameManager', 'OnWalletConnected', walletAddress);
              console.log('‚úÖ Wallet sent to Unity');
            } catch(e) {
              console.warn('‚ö†Ô∏è Failed to send wallet to Unity:', e);
            }
          }
          
          if (gameId) {
            try {
              unityInstance.SendMessage('GameManager', 'SetGameId', gameId);
              console.log('‚úÖ Game ID sent to Unity');
            } catch(e) {
              console.warn('‚ö†Ô∏è Failed to send game ID to Unity:', e);
            }
          }
          
          // Notify bridge that Unity is ready
          if (typeof window.__kulino_unity_ready === 'function') {
            window.__kulino_unity_ready();
            console.log('‚úÖ Bridge notified');
          }
          
        }).catch((message) => {
          console.error('‚ùå Unity failed to load:', message);
          alert('Failed to load game: ' + message);
        });
      };
      
      script.onerror = (e) => {
        console.error('‚ùå Failed to load Unity loader:', loaderUrl, e);
        unityShowBanner('Failed to load Unity loader: ' + loaderUrl, 'error');
      };
      
      document.body.appendChild(script);
    </script>
  </body>
</html>
